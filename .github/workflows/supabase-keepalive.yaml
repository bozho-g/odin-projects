name: Supabase Keepalive
'on':
  schedule:
    - cron: 17 3,15 * * *
  workflow_dispatch: {}
jobs:
  keepalive:
    runs-on: ubuntu-latest
    steps:
      - name: Keepalive (Messaging App)
        env:
          URL: '${{ secrets.SUPABASE_MESSAGING_URL }}'
          KEY: '${{ secrets.SUPABASE_MESSAGING_SERVICE_ROLE_KEY }}'
          ANON: '${{ secrets.SUPABASE_MESSAGING_ANON_KEY }}'
        run: |
          set -euxo pipefail

          echo "Supabase host: $(echo "$URL" | sed -E 's#https?://([^/]+).*#\1#')"

          curl -vfsS "$URL/rest/v1/keepalive_log?select=id&limit=1" \
            -H "apikey: $ANON" \
            -H "Authorization: Bearer $ANON"

          curl -vfsS -X POST "$URL/rest/v1/keepalive_log" \
            -H "apikey: $KEY" \
            -H "Authorization: Bearer $KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data '[{}]'
      - name: Keepalive (File Uploader)
        env:
          URL: '${{ secrets.SUPABASE_FILEUP_URL }}'
          KEY: '${{ secrets.SUPABASE_FILEUP_SERVICE_ROLE_KEY }}'
          ANON: '${{ secrets.SUPABASE_FILEUP_ANON_KEY }}'
        run: |
          set -euxo pipefail

          echo "Supabase host: $(echo "$URL" | sed -E 's#https?://([^/]+).*#\1#')"

          curl -vfsS "$URL/rest/v1/keepalive_log?select=id&limit=1" \
            -H "apikey: $ANON" \
            -H "Authorization: Bearer $ANON"

          curl -vfsS -X POST "$URL/rest/v1/keepalive_log" \
            -H "apikey: $KEY" \
            -H "Authorization: Bearer $KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data '[{}]'
      - name: Keepalive (Inventory App)
        env:
          URL: '${{ secrets.SUPABASE_INVENTORY_URL }}'
          KEY: '${{ secrets.SUPABASE_INVENTORY_SERVICE_ROLE_KEY }}'
          ANON: '${{ secrets.SUPABASE_INVENTORY_ANON_KEY }}'
        run: |
          set -euxo pipefail

          echo "Supabase host: $(echo "$URL" | sed -E 's#https?://([^/]+).*#\1#')"

          curl -vfsS "$URL/rest/v1/keepalive_log?select=id&limit=1" \
            -H "apikey: $ANON" \
            -H "Authorization: Bearer $ANON"

          curl -vfsS -X POST "$URL/rest/v1/keepalive_log" \
            -H "apikey: $KEY" \
            -H "Authorization: Bearer $KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data '[{}]'
      - name: Keepalive (Messaging Board)
        env:
          URL: '${{ secrets.SUPABASE_BOARD_URL }}'
          KEY: '${{ secrets.SUPABASE_BOARD_SERVICE_ROLE_KEY }}'
          ANON: '${{ secrets.SUPABASE_BOARD_ANON_KEY }}'
        run: |
          set -euxo pipefail

          echo "Supabase host: $(echo "$URL" | sed -E 's#https?://([^/]+).*#\1#')"

          curl -vfsS "$URL/rest/v1/keepalive_log?select=id&limit=1" \
            -H "apikey: $ANON" \
            -H "Authorization: Bearer $ANON"

          curl -vfsS -X POST "$URL/rest/v1/keepalive_log" \
            -H "apikey: $KEY" \
            -H "Authorization: Bearer $KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            --data '[{}]'